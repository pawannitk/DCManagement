{"ast":null,"code":"(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n/* eslint-disable camelcase */\n/* eslint prefer-const: 2 */\nimport shortid from 'shortid';\nimport { SupersetClient } from '@superset-ui/core';\n\nimport { safeStringify } from '../utils/safeStringify';\nimport { LOG_EVENT } from '../logger/actions';\nimport { LOG_EVENT_TYPE_TIMING } from '../logger/LogUtils';\nimport DebouncedMessageQueue from '../utils/DebouncedMessageQueue';\n\nconst LOG_ENDPOINT = '/superset/log/?explode=events';\nconst sendBeacon = (events) => {\n  if (events.length <= 0) {\n    return;\n  }\n\n  let endpoint = LOG_ENDPOINT;\n  const { source, source_id } = events[0];\n  // backend logs treat these request params as first-class citizens\n  if (source === 'dashboard') {\n    endpoint += `&dashboard_id=${source_id}`;\n  } else if (source === 'slice') {\n    endpoint += `&slice_id=${source_id}`;\n  }\n\n  if (navigator.sendBeacon) {\n    const formData = new FormData();\n    formData.append('events', safeStringify(events));\n    if (SupersetClient.getGuestToken()) {\n      // if we have a guest token, we need to send it for auth via the form\n      formData.append('guest_token', SupersetClient.getGuestToken());\n    }\n    navigator.sendBeacon(endpoint, formData);\n  } else {\n    SupersetClient.post({\n      endpoint,\n      postPayload: { events },\n      parseMethod: null\n    });\n  }\n};\n\n// beacon API has data size limit = 2^16.\n// assume avg each log entry has 2^6 characters\nconst MAX_EVENTS_PER_REQUEST = 1024;\nconst logMessageQueue = new DebouncedMessageQueue({\n  callback: sendBeacon,\n  sizeThreshold: MAX_EVENTS_PER_REQUEST,\n  delayThreshold: 1000\n});\nlet lastEventId = 0;\nconst loggerMiddleware = (store) => (next) => (action) => {var _dashboardLayout$pres;\n  if (action.type !== LOG_EVENT) {\n    return next(action);\n  }\n\n  const { dashboardInfo, explore, impressionId, dashboardLayout, sqlLab } =\n  store.getState();\n  let logMetadata = {\n    impression_id: impressionId,\n    version: 'v2'\n  };\n  if (dashboardInfo != null && dashboardInfo.id) {\n    logMetadata = {\n      source: 'dashboard',\n      source_id: dashboardInfo.id,\n      ...logMetadata\n    };\n  } else if (explore != null && explore.slice) {\n    logMetadata = {\n      source: 'explore',\n      source_id: explore.slice ? explore.slice.slice_id : 0,\n      ...logMetadata\n    };\n  } else if (sqlLab) {\n    const editor = sqlLab.queryEditors.find(\n      ({ id }) => id === sqlLab.tabHistory.slice(-1)[0]\n    );\n    logMetadata = {\n      source: 'sqlLab',\n      source_id: editor == null ? void 0 : editor.id,\n      db_id: editor == null ? void 0 : editor.dbId,\n      schema: editor == null ? void 0 : editor.schema\n    };\n  }\n\n  const { eventName } = action.payload;\n  let { eventData = {} } = action.payload;\n  eventData = {\n    ...logMetadata,\n    ts: new Date().getTime(),\n    event_name: eventName,\n    ...eventData\n  };\n  if (LOG_EVENT_TYPE_TIMING.has(eventName)) {\n    eventData = {\n      ...eventData,\n      event_type: 'timing',\n      trigger_event: lastEventId\n    };\n  } else {\n    lastEventId = shortid.generate();\n    eventData = {\n      ...eventData,\n      event_type: 'user',\n      event_id: lastEventId,\n      visibility: document.visibilityState\n    };\n  }\n\n  if (eventData.target_id && dashboardLayout != null && (_dashboardLayout$pres = dashboardLayout.present) != null && _dashboardLayout$pres[eventData.target_id]) {\n    const { meta } = dashboardLayout.present[eventData.target_id];\n    // chart name or tab/header text\n    eventData.target_name = meta.chartId ? meta.sliceName : meta.text;\n  }\n\n  logMessageQueue.append(eventData);\n  return eventData;\n};const _default =\n\nloggerMiddleware;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(LOG_ENDPOINT, \"LOG_ENDPOINT\", \"/home/pawank/Documents/dcim/superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(sendBeacon, \"sendBeacon\", \"/home/pawank/Documents/dcim/superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(MAX_EVENTS_PER_REQUEST, \"MAX_EVENTS_PER_REQUEST\", \"/home/pawank/Documents/dcim/superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(logMessageQueue, \"logMessageQueue\", \"/home/pawank/Documents/dcim/superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(lastEventId, \"lastEventId\", \"/home/pawank/Documents/dcim/superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(loggerMiddleware, \"loggerMiddleware\", \"/home/pawank/Documents/dcim/superset/superset-frontend/src/middleware/loggerMiddleware.js\");reactHotLoader.register(_default, \"default\", \"/home/pawank/Documents/dcim/superset/superset-frontend/src/middleware/loggerMiddleware.js\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"names":["shortid","SupersetClient","safeStringify","LOG_EVENT","LOG_EVENT_TYPE_TIMING","DebouncedMessageQueue","LOG_ENDPOINT","sendBeacon","events","length","endpoint","source","source_id","navigator","formData","FormData","append","getGuestToken","post","postPayload","parseMethod","MAX_EVENTS_PER_REQUEST","logMessageQueue","callback","sizeThreshold","delayThreshold","lastEventId","loggerMiddleware","store","next","action","_dashboardLayout$pres","type","dashboardInfo","explore","impressionId","dashboardLayout","sqlLab","getState","logMetadata","impression_id","version","id","slice","slice_id","editor","queryEditors","find","tabHistory","db_id","dbId","schema","eventName","payload","eventData","ts","Date","getTime","event_name","has","event_type","trigger_event","generate","event_id","visibility","document","visibilityState","target_id","present","meta","target_name","chartId","sliceName","text","_default","reactHotLoader","reactHotLoaderGlobal","default","undefined","register","leaveModule","module"],"sources":["/home/pawank/Documents/dcim/superset/superset-frontend/src/middleware/loggerMiddleware.js"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n/* eslint-disable camelcase */\n/* eslint prefer-const: 2 */\nimport shortid from 'shortid';\nimport { SupersetClient } from '@superset-ui/core';\n\nimport { safeStringify } from '../utils/safeStringify';\nimport { LOG_EVENT } from '../logger/actions';\nimport { LOG_EVENT_TYPE_TIMING } from '../logger/LogUtils';\nimport DebouncedMessageQueue from '../utils/DebouncedMessageQueue';\n\nconst LOG_ENDPOINT = '/superset/log/?explode=events';\nconst sendBeacon = events => {\n  if (events.length <= 0) {\n    return;\n  }\n\n  let endpoint = LOG_ENDPOINT;\n  const { source, source_id } = events[0];\n  // backend logs treat these request params as first-class citizens\n  if (source === 'dashboard') {\n    endpoint += `&dashboard_id=${source_id}`;\n  } else if (source === 'slice') {\n    endpoint += `&slice_id=${source_id}`;\n  }\n\n  if (navigator.sendBeacon) {\n    const formData = new FormData();\n    formData.append('events', safeStringify(events));\n    if (SupersetClient.getGuestToken()) {\n      // if we have a guest token, we need to send it for auth via the form\n      formData.append('guest_token', SupersetClient.getGuestToken());\n    }\n    navigator.sendBeacon(endpoint, formData);\n  } else {\n    SupersetClient.post({\n      endpoint,\n      postPayload: { events },\n      parseMethod: null,\n    });\n  }\n};\n\n// beacon API has data size limit = 2^16.\n// assume avg each log entry has 2^6 characters\nconst MAX_EVENTS_PER_REQUEST = 1024;\nconst logMessageQueue = new DebouncedMessageQueue({\n  callback: sendBeacon,\n  sizeThreshold: MAX_EVENTS_PER_REQUEST,\n  delayThreshold: 1000,\n});\nlet lastEventId = 0;\nconst loggerMiddleware = store => next => action => {\n  if (action.type !== LOG_EVENT) {\n    return next(action);\n  }\n\n  const { dashboardInfo, explore, impressionId, dashboardLayout, sqlLab } =\n    store.getState();\n  let logMetadata = {\n    impression_id: impressionId,\n    version: 'v2',\n  };\n  if (dashboardInfo?.id) {\n    logMetadata = {\n      source: 'dashboard',\n      source_id: dashboardInfo.id,\n      ...logMetadata,\n    };\n  } else if (explore?.slice) {\n    logMetadata = {\n      source: 'explore',\n      source_id: explore.slice ? explore.slice.slice_id : 0,\n      ...logMetadata,\n    };\n  } else if (sqlLab) {\n    const editor = sqlLab.queryEditors.find(\n      ({ id }) => id === sqlLab.tabHistory.slice(-1)[0],\n    );\n    logMetadata = {\n      source: 'sqlLab',\n      source_id: editor?.id,\n      db_id: editor?.dbId,\n      schema: editor?.schema,\n    };\n  }\n\n  const { eventName } = action.payload;\n  let { eventData = {} } = action.payload;\n  eventData = {\n    ...logMetadata,\n    ts: new Date().getTime(),\n    event_name: eventName,\n    ...eventData,\n  };\n  if (LOG_EVENT_TYPE_TIMING.has(eventName)) {\n    eventData = {\n      ...eventData,\n      event_type: 'timing',\n      trigger_event: lastEventId,\n    };\n  } else {\n    lastEventId = shortid.generate();\n    eventData = {\n      ...eventData,\n      event_type: 'user',\n      event_id: lastEventId,\n      visibility: document.visibilityState,\n    };\n  }\n\n  if (eventData.target_id && dashboardLayout?.present?.[eventData.target_id]) {\n    const { meta } = dashboardLayout.present[eventData.target_id];\n    // chart name or tab/header text\n    eventData.target_name = meta.chartId ? meta.sliceName : meta.text;\n  }\n\n  logMessageQueue.append(eventData);\n  return eventData;\n};\n\nexport default loggerMiddleware;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}