{"ast":null,"code":"(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;};import { COORDINATE_SYSTEM } from '../../lib/constants';\nimport { getOffsetOrigin } from './viewport-uniforms';\nimport WebMercatorViewport from '../../viewports/web-mercator-viewport';\nimport * as vec4 from 'gl-matrix/vec4';\nimport * as vec3 from 'gl-matrix/vec3';\nimport { addMetersToLngLat } from '@math.gl/web-mercator';\nconst DEFAULT_COORDINATE_ORIGIN = [0, 0, 0];\n\nfunction lngLatZToWorldPosition(lngLatZ, viewport, offsetMode = false) {\n  const p = viewport.projectPosition(lngLatZ);\n\n  if (offsetMode && viewport instanceof WebMercatorViewport) {\n    const [longitude, latitude, z = 0] = lngLatZ;\n    const distanceScales = viewport.getDistanceScales([longitude, latitude]);\n    p[2] = z * distanceScales.unitsPerMeter[2];\n  }\n\n  return p;\n}\n\nfunction normalizeParameters(opts) {\n  const {\n    viewport,\n    modelMatrix,\n    coordinateOrigin\n  } = opts;\n  let {\n    coordinateSystem,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  } = opts;\n\n  if (coordinateSystem === COORDINATE_SYSTEM.DEFAULT) {\n    coordinateSystem = viewport.isGeospatial ? COORDINATE_SYSTEM.LNGLAT : COORDINATE_SYSTEM.CARTESIAN;\n  }\n\n  if (fromCoordinateSystem === undefined) {\n    fromCoordinateSystem = coordinateSystem;\n  }\n\n  if (fromCoordinateOrigin === undefined) {\n    fromCoordinateOrigin = coordinateOrigin;\n  }\n\n  return {\n    viewport,\n    coordinateSystem,\n    coordinateOrigin,\n    modelMatrix,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  };\n}\n\nexport function getWorldPosition(position, {\n  viewport,\n  modelMatrix,\n  coordinateSystem,\n  coordinateOrigin,\n  offsetMode\n}) {\n  let [x, y, z = 0] = position;\n\n  if (modelMatrix) {\n    [x, y, z] = vec4.transformMat4([], [x, y, z, 1.0], modelMatrix);\n  }\n\n  switch (coordinateSystem) {\n    case COORDINATE_SYSTEM.LNGLAT:\n      return lngLatZToWorldPosition([x, y, z], viewport, offsetMode);\n\n    case COORDINATE_SYSTEM.LNGLAT_OFFSETS:\n      return lngLatZToWorldPosition([x + coordinateOrigin[0], y + coordinateOrigin[1], z + (coordinateOrigin[2] || 0)], viewport, offsetMode);\n\n    case COORDINATE_SYSTEM.METER_OFFSETS:\n      return lngLatZToWorldPosition(addMetersToLngLat(coordinateOrigin, [x, y, z]), viewport, offsetMode);\n\n    case COORDINATE_SYSTEM.CARTESIAN:\n    default:\n      return viewport.isGeospatial ? [x + coordinateOrigin[0], y + coordinateOrigin[1], z + coordinateOrigin[2]] : viewport.projectPosition([x, y, z]);\n  }\n}\nexport function projectPosition(position, params) {\n  const {\n    viewport,\n    coordinateSystem,\n    coordinateOrigin,\n    modelMatrix,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  } = normalizeParameters(params);\n  const {\n    autoOffset = true\n  } = params;\n  const {\n    geospatialOrigin = DEFAULT_COORDINATE_ORIGIN,\n    shaderCoordinateOrigin = DEFAULT_COORDINATE_ORIGIN,\n    offsetMode = false\n  } = autoOffset ? getOffsetOrigin(viewport, coordinateSystem, coordinateOrigin) : {};\n  const worldPosition = getWorldPosition(position, {\n    viewport,\n    modelMatrix,\n    coordinateSystem: fromCoordinateSystem,\n    coordinateOrigin: fromCoordinateOrigin,\n    offsetMode\n  });\n\n  if (offsetMode) {\n    const positionCommonSpace = viewport.projectPosition(geospatialOrigin || shaderCoordinateOrigin);\n    vec3.sub(worldPosition, worldPosition, positionCommonSpace);\n  }\n\n  return worldPosition;\n};(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(DEFAULT_COORDINATE_ORIGIN, \"DEFAULT_COORDINATE_ORIGIN\", \"/home/pawank/Documents/dcim/superset/superset-frontend/plugins/legacy-preset-chart-deckgl/node_modules/@deck.gl/core/dist/esm/shaderlib/project/project-functions.js\");reactHotLoader.register(lngLatZToWorldPosition, \"lngLatZToWorldPosition\", \"/home/pawank/Documents/dcim/superset/superset-frontend/plugins/legacy-preset-chart-deckgl/node_modules/@deck.gl/core/dist/esm/shaderlib/project/project-functions.js\");reactHotLoader.register(normalizeParameters, \"normalizeParameters\", \"/home/pawank/Documents/dcim/superset/superset-frontend/plugins/legacy-preset-chart-deckgl/node_modules/@deck.gl/core/dist/esm/shaderlib/project/project-functions.js\");reactHotLoader.register(getWorldPosition, \"getWorldPosition\", \"/home/pawank/Documents/dcim/superset/superset-frontend/plugins/legacy-preset-chart-deckgl/node_modules/@deck.gl/core/dist/esm/shaderlib/project/project-functions.js\");reactHotLoader.register(projectPosition, \"projectPosition\", \"/home/pawank/Documents/dcim/superset/superset-frontend/plugins/legacy-preset-chart-deckgl/node_modules/@deck.gl/core/dist/esm/shaderlib/project/project-functions.js\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"names":["COORDINATE_SYSTEM","getOffsetOrigin","WebMercatorViewport","vec4","vec3","addMetersToLngLat","DEFAULT_COORDINATE_ORIGIN","lngLatZToWorldPosition","lngLatZ","viewport","offsetMode","p","projectPosition","longitude","latitude","z","distanceScales","getDistanceScales","unitsPerMeter","normalizeParameters","opts","modelMatrix","coordinateOrigin","coordinateSystem","fromCoordinateSystem","fromCoordinateOrigin","DEFAULT","isGeospatial","LNGLAT","CARTESIAN","undefined","getWorldPosition","position","x","y","transformMat4","LNGLAT_OFFSETS","METER_OFFSETS","params","autoOffset","geospatialOrigin","shaderCoordinateOrigin","worldPosition","positionCommonSpace","sub","reactHotLoader","reactHotLoaderGlobal","default","register","leaveModule","module"],"sources":["../../../../src/shaderlib/project/project-functions.ts"],"sourcesContent":["/**\n * Projection utils\n * TODO: move to Viewport class?\n */\nimport {COORDINATE_SYSTEM} from '../../lib/constants';\nimport {getOffsetOrigin} from './viewport-uniforms';\nimport WebMercatorViewport from '../../viewports/web-mercator-viewport';\n\nimport * as vec4 from 'gl-matrix/vec4';\nimport * as vec3 from 'gl-matrix/vec3';\nimport {addMetersToLngLat} from '@math.gl/web-mercator';\n\nimport type {CoordinateSystem} from '../../lib/constants';\nimport type Viewport from '../../viewports/viewport';\nimport type {NumericArray} from '../../types/types';\n\nconst DEFAULT_COORDINATE_ORIGIN = [0, 0, 0];\n\n// In project.glsl, offset modes calculate z differently from LNG_LAT mode.\n// offset modes apply the y adjustment (unitsPerMeter2) when projecting z\n// LNG_LAT mode only use the linear scale.\nfunction lngLatZToWorldPosition(\n  lngLatZ: [number, number, number],\n  viewport: Viewport,\n  offsetMode: boolean = false\n): [number, number, number] {\n  const p = viewport.projectPosition(lngLatZ);\n\n  // TODO - avoid using instanceof\n  if (offsetMode && viewport instanceof WebMercatorViewport) {\n    const [longitude, latitude, z = 0] = lngLatZ;\n    const distanceScales = viewport.getDistanceScales([longitude, latitude]);\n    p[2] = z * distanceScales.unitsPerMeter[2];\n  }\n  return p;\n}\n\nfunction normalizeParameters(opts: {\n  viewport: Viewport;\n  coordinateSystem: CoordinateSystem;\n  coordinateOrigin: [number, number, number];\n  modelMatrix?: NumericArray | null;\n  fromCoordinateSystem?: CoordinateSystem;\n  fromCoordinateOrigin?: [number, number, number];\n}): {\n  viewport: Viewport;\n  coordinateSystem: CoordinateSystem;\n  coordinateOrigin: [number, number, number];\n  modelMatrix?: NumericArray | null;\n  fromCoordinateSystem: CoordinateSystem;\n  fromCoordinateOrigin: [number, number, number];\n} {\n  const {viewport, modelMatrix, coordinateOrigin} = opts;\n  let {coordinateSystem, fromCoordinateSystem, fromCoordinateOrigin} = opts;\n\n  if (coordinateSystem === COORDINATE_SYSTEM.DEFAULT) {\n    coordinateSystem = viewport.isGeospatial\n      ? COORDINATE_SYSTEM.LNGLAT\n      : COORDINATE_SYSTEM.CARTESIAN;\n  }\n\n  if (fromCoordinateSystem === undefined) {\n    fromCoordinateSystem = coordinateSystem;\n  }\n  if (fromCoordinateOrigin === undefined) {\n    fromCoordinateOrigin = coordinateOrigin;\n  }\n\n  return {\n    viewport,\n    coordinateSystem,\n    coordinateOrigin,\n    modelMatrix,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  };\n}\n\n/** Get the common space position from world coordinates in the given coordinate system */\nexport function getWorldPosition(\n  position: number[],\n  {\n    viewport,\n    modelMatrix,\n    coordinateSystem,\n    coordinateOrigin,\n    offsetMode\n  }: {\n    viewport: Viewport;\n    modelMatrix?: NumericArray | null;\n    coordinateSystem: CoordinateSystem;\n    coordinateOrigin: [number, number, number];\n    offsetMode?: boolean;\n  }\n): [number, number, number] {\n  let [x, y, z = 0] = position;\n\n  if (modelMatrix) {\n    [x, y, z] = vec4.transformMat4([], [x, y, z, 1.0], modelMatrix);\n  }\n\n  switch (coordinateSystem) {\n    case COORDINATE_SYSTEM.LNGLAT:\n      return lngLatZToWorldPosition([x, y, z], viewport, offsetMode);\n\n    case COORDINATE_SYSTEM.LNGLAT_OFFSETS:\n      return lngLatZToWorldPosition(\n        [x + coordinateOrigin[0], y + coordinateOrigin[1], z + (coordinateOrigin[2] || 0)],\n        viewport,\n        offsetMode\n      );\n\n    case COORDINATE_SYSTEM.METER_OFFSETS:\n      return lngLatZToWorldPosition(\n        addMetersToLngLat(coordinateOrigin, [x, y, z]) as [number, number, number],\n        viewport,\n        offsetMode\n      );\n\n    case COORDINATE_SYSTEM.CARTESIAN:\n    default:\n      return viewport.isGeospatial\n        ? [x + coordinateOrigin[0], y + coordinateOrigin[1], z + coordinateOrigin[2]]\n        : viewport.projectPosition([x, y, z]);\n  }\n}\n\n/**\n * Equivalent to project_position in project.glsl\n * projects a user supplied position to world position directly with or without\n * a reference coordinate system\n */\nexport function projectPosition(\n  position: number[],\n  params: {\n    /** The current viewport */\n    viewport: Viewport;\n    /** The reference coordinate system used to align world position */\n    coordinateSystem: CoordinateSystem;\n    /** The reference coordinate origin used to align world position */\n    coordinateOrigin: [number, number, number];\n    /** The model matrix of the supplied position */\n    modelMatrix?: NumericArray | null;\n    /** The coordinate system that the supplied position is in. Default to the same as `coordinateSystem`. */\n    fromCoordinateSystem?: CoordinateSystem;\n    /** The coordinate origin that the supplied position is in. Default to the same as `coordinateOrigin`. */\n    fromCoordinateOrigin?: [number, number, number];\n    /** Whether to apply offset mode automatically as does the project shader module.\n     * Offset mode places the origin of the common space at the given viewport's center. It is used in some use cases\n     * to improve precision in the vertex shader due to the fp32 float limitation.\n     * Use `autoOffset:false` if the returned position should not be dependent on the current viewport.\n     * Default `true` */\n    autoOffset?: boolean;\n  }\n): [number, number, number] {\n  const {\n    viewport,\n    coordinateSystem,\n    coordinateOrigin,\n    modelMatrix,\n    fromCoordinateSystem,\n    fromCoordinateOrigin\n  } = normalizeParameters(params);\n  const {autoOffset = true} = params;\n\n  const {\n    geospatialOrigin = DEFAULT_COORDINATE_ORIGIN,\n    shaderCoordinateOrigin = DEFAULT_COORDINATE_ORIGIN,\n    offsetMode = false\n  } = autoOffset ? getOffsetOrigin(viewport, coordinateSystem, coordinateOrigin) : {};\n\n  const worldPosition = getWorldPosition(position, {\n    viewport,\n    modelMatrix,\n    coordinateSystem: fromCoordinateSystem,\n    coordinateOrigin: fromCoordinateOrigin,\n    offsetMode\n  });\n\n  if (offsetMode) {\n    const positionCommonSpace = viewport.projectPosition(\n      geospatialOrigin || shaderCoordinateOrigin\n    );\n    vec3.sub(worldPosition, worldPosition, positionCommonSpace);\n  }\n\n  return worldPosition;\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}