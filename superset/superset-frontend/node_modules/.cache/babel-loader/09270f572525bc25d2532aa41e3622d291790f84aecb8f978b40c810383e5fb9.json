{"ast":null,"code":"import _cloneDeep from \"lodash/cloneDeep\"; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;};\n\nimport { Behavior, FeatureFlag, getChartMetadataRegistry, isDefined, isFeatureEnabled } from '@superset-ui/core';\nimport { getChartIdsInFilterScope } from './getChartIdsInFilterScope';\nimport { GLOBAL_SCOPE_POINTER, isCrossFilterScopeGlobal } from '../types';\nimport { DEFAULT_CROSS_FILTER_SCOPING } from '../constants';\nexport const isCrossFiltersEnabled = (metadataCrossFiltersEnabled) => isFeatureEnabled(FeatureFlag.DashboardCrossFilters) && (\nmetadataCrossFiltersEnabled === undefined || metadataCrossFiltersEnabled);\nexport const getCrossFiltersConfiguration = (dashboardLayout, metadata, charts) => {var _metadata$global_char;\n  if (!isFeatureEnabled(FeatureFlag.DashboardCrossFilters)) {\n    return undefined;\n  }\n  const globalChartConfiguration = (_metadata$global_char = metadata.global_chart_configuration) != null && _metadata$global_char.scope ?\n  {\n    scope: metadata.global_chart_configuration.scope,\n    chartsInScope: getChartIdsInFilterScope(metadata.global_chart_configuration.scope, Object.values(charts).map((chart) => chart.id), dashboardLayout)\n  } :\n  {\n    scope: DEFAULT_CROSS_FILTER_SCOPING,\n    chartsInScope: Object.values(charts).map((chart) => chart.id)\n  };\n  // If user just added cross filter to dashboard it's not saving its scope on server,\n  // so we tweak it until user will update scope and will save it in server\n  const chartConfiguration = {};\n  Object.values(dashboardLayout).forEach((layoutItem) => {var _layoutItem$meta, _behaviors, _ref, _getChartMetadataRegi, _charts$chartId, _charts$chartId$form_;\n    const chartId = (_layoutItem$meta = layoutItem.meta) == null ? void 0 : _layoutItem$meta.chartId;\n    if (!isDefined(chartId)) {\n      return;\n    }\n    const behaviors = (_behaviors = (_ref = (_getChartMetadataRegi = getChartMetadataRegistry().get((_charts$chartId = charts[chartId]) == null ? void 0 : (_charts$chartId$form_ = _charts$chartId.form_data) == null ? void 0 : _charts$chartId$form_.viz_type)) != null ? _getChartMetadataRegi :\n    {}) == null ? void 0 : _ref.behaviors) != null ? _behaviors : [];\n    if (behaviors.includes(Behavior.InteractiveChart)) {var _metadata$chart_confi;\n      if ((_metadata$chart_confi = metadata.chart_configuration) != null && _metadata$chart_confi[chartId]) {\n        // We need to clone to avoid mutating Redux state\n        chartConfiguration[chartId] = _cloneDeep(metadata.chart_configuration[chartId]);\n      }\n      if (!chartConfiguration[chartId]) {\n        chartConfiguration[chartId] = {\n          id: chartId,\n          crossFilters: {\n            scope: GLOBAL_SCOPE_POINTER\n          }\n        };\n      }\n      chartConfiguration[chartId].crossFilters.chartsInScope =\n      isCrossFilterScopeGlobal(chartConfiguration[chartId].crossFilters.scope) ?\n      globalChartConfiguration.chartsInScope.filter((id) => id !== Number(chartId)) :\n      getChartIdsInFilterScope(chartConfiguration[chartId].crossFilters.scope, Object.values(charts).map((chart) => chart.id), dashboardLayout);\n    }\n  });\n  return { chartConfiguration, globalChartConfiguration };\n};;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(isCrossFiltersEnabled, \"isCrossFiltersEnabled\", \"/home/pawank/Documents/dcim/superset/superset-frontend/src/dashboard/util/crossFilters.ts\");reactHotLoader.register(getCrossFiltersConfiguration, \"getCrossFiltersConfiguration\", \"/home/pawank/Documents/dcim/superset/superset-frontend/src/dashboard/util/crossFilters.ts\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"names":["enterModule","reactHotLoaderGlobal","undefined","module","__signature__","default","signature","a","Behavior","FeatureFlag","getChartMetadataRegistry","isDefined","isFeatureEnabled","getChartIdsInFilterScope","GLOBAL_SCOPE_POINTER","isCrossFilterScopeGlobal","DEFAULT_CROSS_FILTER_SCOPING","isCrossFiltersEnabled","metadataCrossFiltersEnabled","DashboardCrossFilters","getCrossFiltersConfiguration","dashboardLayout","metadata","charts","_metadata$global_char","globalChartConfiguration","global_chart_configuration","scope","chartsInScope","Object","values","map","chart","id","chartConfiguration","forEach","layoutItem","_layoutItem$meta","_behaviors","_ref","_getChartMetadataRegi","_charts$chartId","_charts$chartId$form_","chartId","meta","behaviors","get","form_data","viz_type","includes","InteractiveChart","_metadata$chart_confi","chart_configuration","_cloneDeep","crossFilters","filter","Number","reactHotLoader","register","leaveModule"],"sources":["/home/pawank/Documents/dcim/superset/superset-frontend/src/dashboard/util/crossFilters.ts"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport { cloneDeep } from 'lodash';\nimport {\n  Behavior,\n  FeatureFlag,\n  getChartMetadataRegistry,\n  isDefined,\n  isFeatureEnabled,\n} from '@superset-ui/core';\nimport { getChartIdsInFilterScope } from './getChartIdsInFilterScope';\nimport {\n  ChartsState,\n  DashboardInfo,\n  DashboardLayout,\n  GLOBAL_SCOPE_POINTER,\n  isCrossFilterScopeGlobal,\n} from '../types';\nimport { DEFAULT_CROSS_FILTER_SCOPING } from '../constants';\n\nexport const isCrossFiltersEnabled = (\n  metadataCrossFiltersEnabled: boolean | undefined,\n): boolean =>\n  isFeatureEnabled(FeatureFlag.DashboardCrossFilters) &&\n  (metadataCrossFiltersEnabled === undefined || metadataCrossFiltersEnabled);\n\nexport const getCrossFiltersConfiguration = (\n  dashboardLayout: DashboardLayout,\n  metadata: Pick<\n    DashboardInfo['metadata'],\n    'chart_configuration' | 'global_chart_configuration'\n  >,\n  charts: ChartsState,\n) => {\n  if (!isFeatureEnabled(FeatureFlag.DashboardCrossFilters)) {\n    return undefined;\n  }\n\n  const globalChartConfiguration = metadata.global_chart_configuration?.scope\n    ? {\n        scope: metadata.global_chart_configuration.scope,\n        chartsInScope: getChartIdsInFilterScope(\n          metadata.global_chart_configuration.scope,\n          Object.values(charts).map(chart => chart.id),\n          dashboardLayout,\n        ),\n      }\n    : {\n        scope: DEFAULT_CROSS_FILTER_SCOPING,\n        chartsInScope: Object.values(charts).map(chart => chart.id),\n      };\n\n  // If user just added cross filter to dashboard it's not saving its scope on server,\n  // so we tweak it until user will update scope and will save it in server\n  const chartConfiguration = {};\n  Object.values(dashboardLayout).forEach(layoutItem => {\n    const chartId = layoutItem.meta?.chartId;\n\n    if (!isDefined(chartId)) {\n      return;\n    }\n\n    const behaviors =\n      (\n        getChartMetadataRegistry().get(charts[chartId]?.form_data?.viz_type) ??\n        {}\n      )?.behaviors ?? [];\n\n    if (behaviors.includes(Behavior.InteractiveChart)) {\n      if (metadata.chart_configuration?.[chartId]) {\n        // We need to clone to avoid mutating Redux state\n        chartConfiguration[chartId] = cloneDeep(\n          metadata.chart_configuration[chartId],\n        );\n      }\n      if (!chartConfiguration[chartId]) {\n        chartConfiguration[chartId] = {\n          id: chartId,\n          crossFilters: {\n            scope: GLOBAL_SCOPE_POINTER,\n          },\n        };\n      }\n      chartConfiguration[chartId].crossFilters.chartsInScope =\n        isCrossFilterScopeGlobal(chartConfiguration[chartId].crossFilters.scope)\n          ? globalChartConfiguration.chartsInScope.filter(\n              id => id !== Number(chartId),\n            )\n          : getChartIdsInFilterScope(\n              chartConfiguration[chartId].crossFilters.scope,\n              Object.values(charts).map(chart => chart.id),\n              dashboardLayout,\n            );\n    }\n  });\n\n  return { chartConfiguration, globalChartConfiguration };\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}